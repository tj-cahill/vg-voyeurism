---
title: "Watching Video Games - Secondary Analysis"
author: "Tiernan J. Cahill"
output: html_notebook
---

This script takes the cleaned output from the DATA_MERGE script and runs some exploratory data analysis, following hypothesis testing, to look at some of our additional research questions.

```{r setup, include=FALSE}
library(dplyr)
library(knitr)
library(ggplot2)
library(ggpubr)
readRDS(file = "data/merged_all.rds") -> vgv
readRDS(file = "data/Qualtrics_merged.rds") -> qualtrics
```

# Research Questions
## RQ1: Gender -> PSI
### Sexual Orientation
RQ1a is: *Will viewers whose sexual orientation aligns with the gender of the streamer experience different levels of parasocial interaction (PSI) than others?*

This can be answered looking at self-report data alone, but first we need to determine for each participant whether their sexual orientation aligns with the gender of the streamer (i.e., for a participant who reports that they are interested in women or in all genders and were assigned to the condition with the female streamer).
```{r calc-orientation, results='asis'}
vgv <- vgv %>% 
  mutate(orientationMatch = ((stimGender == "FEMALE" & orientation == "Women") |
                             (stimGender == "MALE" & orientation == "Men") |
                             (orientation == "Both")))

# Let's take a quick look at the breakdown of orientations and matches
# Recrate the function from the beginning of the analysis
freq_kable <- function(df, x, digits = 3) {
  table(df[,x]) %>% 
  rbind(prop.table(table(df[,x])) * 100) %>% 
  t() %>% kable(col.names = c("Frequency", "%"), digits = digits)
}

vgv_unique <- vgv %>% 
  select(id, stimGender, gender, orientation, orientationMatch) %>%
  unique()

vgv_unique %>% freq_kable("orientation")
vgv_unique %>% freq_kable("orientationMatch")
```
Note that `r vgv_unique %>% filter(is.na(orientation)) %>% count() %>% .[[1]]` participants did not answer the question about sexual orientation and were excluded from subsequent analysis.

```{r rq1a}
rq1a.data <- vgv %>% 
  select(id, orientationMatch, PSI_Overall) %>%
  filter(!is.na(orientationMatch)) %>%
  unique()

# Visualize the difference between groups using a boxplot
ggboxplot(rq1a.data, x = "orientationMatch", y = "PSI_Overall",
          xlab = "Orientation Match", ylab = "PSI",
          color = "orientationMatch", legend = "none")

# First test for homogeneity of variance
bartlett.test(PSI_Overall ~ orientationMatch, rq1a.data)

# Run a t-test
t.test(PSI_Overall ~ orientationMatch, data = rq1a.data,
       var.equal = TRUE, alternative = "two.sided")
```

From these results, it doesn't appear that there is a meaningful difference in 
parasocial interaction between the two groups of interest.

### Homophily
RQ1b is: *Will viewers whose gender identity aligns with the gender of the streamer experience different levels of parasocial interaction (PSI) than others?*

In order to test for possible homophily effects, we need to determine from the self-report data whether the gender expression of the streamer aligns with the identity of the viewer.
```{r calc-homophily}
vgv <- vgv %>% 
  mutate(identityMatch = ((stimGender == "FEMALE" & gender == "FEMALE") |
                             (stimGender == "MALE" & gender == "MALE")))
```

```{r rq1b}
rq1b.data <- vgv %>% 
  select(id, identityMatch, PSI_Overall) %>%
  unique()

# Visualize the difference between groups using a boxplot
ggboxplot(rq1b.data, x = "identityMatch", y = "PSI_Overall",
          xlab = "Homophily", ylab = "PSI",
          color = "identityMatch", legend = "none")

# First test for homogeneity of variance
bartlett.test(PSI_Overall ~ identityMatch, rq1b.data)

# Run a t-test
t.test(PSI_Overall ~ identityMatch, data = rq1b.data,
       var.equal = TRUE, alternative = "two.sided")
```

From these results, it doesn't appear that there is a meaningful difference in 
parasocial interaction between the two groups of interest.

## RQ2: Gender -> Arousal
### Sexual Orientation
RQ2a is: *Will viewers whose sexual orientation aligns with the gender of the streamer experience different levels of physiological arousal than others?*
```{r rq2a}
# First, create a version of the dataset with one row per participant,
# an aggregate measure of their arousal (GSR) across both stimuli
rq2a.data <- vgv %>% 
  filter(aoi == "GAME") %>%
  group_by(id) %>% 
  summarise(peakCount = sum(peakCount), 
            peaksPerMin = mean(peaksPerMin),
            identityMatch = first(orientationMatch)) %>%
  filter(!is.na(orientationMatch))

# Visualize the difference between groups using a boxplot
ggboxplot(rq2a.data, x = "orientationMatch", y = "peaksPerMin",
          xlab = "Orientation Match", ylab = "GSR",
          color = "orientationMatch", legend = "none")

# There are a few outliers in the biometric data, so use the simple 2*IQR rule 
# to filter them out.
rq2a.data.no_outliers <- rq2a.data %>% 
  filter(peaksPerMin < median(rq2a.data$peaksPerMin, na.rm=T) +
           2*IQR(rq2a.data$peaksPerMin, na.rm=T)) %>%
  filter(peaksPerMin > median(rq2a.data$peaksPerMin, na.rm=T) -
           2*IQR(rq2a.data$peaksPerMin, na.rm=T))

# Visualize again
ggboxplot(rq2a.data.no_outliers, x = "orientationMatch", y = "peaksPerMin",
          xlab = "Orientation Match", ylab = "GSR",
          color = "orientationMatch", legend = "none")

# Now test for homogeneity of variance
bartlett.test(peaksPerMin ~ orientationMatch, rq2a.data.no_outliers)

# Run a t-test
t.test(peaksPerMin ~ orientationMatch, data = rq2a.data.no_outliers,
       var.equal = TRUE, alternative = "two.sided")
```
From these results, it also doesn't appear that there is a meaningful difference in 
physiological arousal between the two groups of interest.

### Homophily
RQ2b is: *Will viewers whose gender identity with the gender of the streamer experience different levels of physiological arousal than others?*

```{r rq2b}
# First, create a version of the dataset with one row per participant,
# an aggregate measure of their arousal (GSR) across both stimuli
rq2b.data <- vgv %>% 
  filter(aoi == "GAME") %>%
  group_by(id) %>% 
  summarise(peakCount = sum(peakCount), 
            peaksPerMin = mean(peaksPerMin),
            identityMatch = first(identityMatch))

# Visualize the difference between groups using a boxplot
ggboxplot(rq2b.data, x = "identityMatch", y = "peaksPerMin",
          xlab = "Homophily", ylab = "GSR",
          color = "identityMatch", legend = "none")

# There are a few outliers in the biometric data, so use the simple 2*IQR rule 
# to filter them out.
rq2b.data.no_outliers <- rq2b.data %>% 
  filter(peaksPerMin < median(rq2b.data$peaksPerMin, na.rm=T) +
           2*IQR(rq2b.data$peaksPerMin, na.rm=T)) %>%
  filter(peaksPerMin > median(rq2b.data$peaksPerMin, na.rm=T) -
           2*IQR(rq2b.data$peaksPerMin, na.rm=T))

# Visualize again
ggboxplot(rq2b.data.no_outliers, x = "identityMatch", y = "peaksPerMin",
          xlab = "Homophily", ylab = "GSR",
          color = "identityMatch", legend = "none")

# Now test for homogeneity of variance
bartlett.test(peaksPerMin ~ identityMatch, rq2b.data.no_outliers)

# Run a t-test
t.test(peaksPerMin ~ identityMatch, data = rq2b.data.no_outliers,
       var.equal = TRUE, alternative = "two.sided")
```
From these results, it also doesn't appear that there is a meaningful difference in 
physiological arousal between the two groups of interest.


## RQ3: Gender -> Attention
### Sexual Orientation
RQ3a is: *Will viewers whose sexual orientation aligns with the gender of the streamer allocate their attention differently than others?*
```{r rq3a}
# First, create a version of the dataset with one row per participant, 
# containing aggregate measures of their relative attention allocation to the
# facecam (thus containing participants in the facecam condition only)

rq3a.data <- vgv %>%
  filter(stimFace == TRUE) %>%
  group_by(id, aoi) %>%
  summarise(totalG = sum(timeSpentG),
            totalF = sum(timeSpentF),
            identityMatch = first(orientationMatch)) %>%
  ungroup() %>%
  arrange(id, aoi) %>%
  mutate(faceRatioG = totalG / (totalG+lead(totalG)),
         faceRatioF = totalF / (totalF+lead(totalF))) %>%
  filter(aoi == "FACE") %>%
  select(-aoi, -totalG, -totalF) %>%
  filter(!is.na(orientationMatch))

# Visualize the difference between groups using a boxplot
ggboxplot(rq3a.data, x = "orientationMatch", y = "faceRatioG",
          xlab = "Orientation Match", ylab = "Gaze Ratio",
          color = "orientationMatch", legend = "none")

# Visualize the difference between groups using a boxplot
ggboxplot(rq3a.data, x = "orientationMatch", y = "faceRatioF",
          xlab = "Orientation Match", ylab = "Fixation Ratio",
          color = "orientationMatch", legend = "none")

# Now test for homogeneity of variance
bartlett.test(faceRatioG ~ orientationMatch, rq3a.data)
bartlett.test(faceRatioF ~ orientationMatch, rq3a.data)

# Run some t-tests
t.test(faceRatioG ~ orientationMatch, data = rq3a.data,
       var.equal = TRUE, alternative = "two.sided")

t.test(faceRatioF ~ orientationMatch, data = rq3a.data,
       var.equal = TRUE, alternative = "two.sided")
```
From these results, it appears that there may be a slightly higher allocation of attention to the facecam among participants whose orientation matched the gender of the streamer, but the difference was marginal and did not approach statistical significance.

### Homophily
RQ3b is: *Will viewers whose gender identity aligns with the gender of the streamer allocate their attention differently than others?*

```{r rq3b}
# First, create a version of the dataset with one row per participant, 
# containing aggregate measures of their relative attention allocation to the
# facecam (thus containing participants in the facecam condition only)

rq3b.data <- vgv %>%
  filter(stimFace == TRUE) %>%
  group_by(id, aoi) %>%
  summarise(totalG = sum(timeSpentG),
            totalF = sum(timeSpentF),
            identityMatch = first(identityMatch)) %>%
  ungroup() %>%
  arrange(id, aoi) %>%
  mutate(faceRatioG = totalG / (totalG+lead(totalG)),
         faceRatioF = totalF / (totalF+lead(totalF))) %>%
  filter(aoi == "FACE") %>%
  select(-aoi, -totalG, -totalF) %>%
  filter(!is.na(identityMatch))

# Visualize the difference between groups using a boxplot
ggboxplot(rq3b.data, x = "identityMatch", y = "faceRatioG",
          xlab = "Homophily", ylab = "Gaze Ratio",
          color = "identityMatch", legend = "none")

# Visualize the difference between groups using a boxplot
ggboxplot(rq3b.data, x = "identityMatch", y = "faceRatioF",
          xlab = "Homophily", ylab = "Fixation Ratio",
          color = "identityMatch", legend = "none")

# Now test for homogeneity of variance
bartlett.test(faceRatioG ~ identityMatch, rq3b.data)
bartlett.test(faceRatioF ~ identityMatch, rq3b.data)

# Run some t-tests
t.test(faceRatioG ~ identityMatch, data = rq3b.data,
       var.equal = TRUE, alternative = "two.sided")

t.test(faceRatioF ~ identityMatch, data = rq3b.data,
       var.equal = TRUE, alternative = "two.sided")
```

From these results, it appears that there is no significant difference in the outcome of interest based on homophily.

## RQ4: Experience -> Attention
RQ4 is: *Do viewers with high levels of experience playing video games allocate their attention differently than inexperienced players when watching a livestream?*

```{r rq4a}
# First, create a version of the dataset with one row per participant, 
# containing aggregate measures of their relative attention allocation to the
# facecam (thus containing participants in the facecam condition only)

rq4a.data <- vgv %>%
  filter(stimFace == TRUE) %>%
  mutate(hrsWatchingVGContent = hrsWatchingRecordedVGContent_weekday * 5 + 
                                hrsWatchingRecordedVGContent_weekend * 2 +
                                hrsWatchingStreamedVGContent_weekday * 5 +
                                hrsWatchingStreamedVGContent_weekend * 2,
         hrsPlayingGames = hrsPlayingSinglePlayer_weekday * 5 +
                           hrsPlayingSinglePlayer_weekend * 2 +
                           hrsPlayingMultiPlayer_weekday * 5 +
                           hrsPlayingMultiPlayer_weekend * 2) %>%
  group_by(id, aoi) %>%
  summarise(totalG = sum(timeSpentG),
            totalF = sum(timeSpentF),
            hrsWatchingVGContent = first(hrsWatchingVGContent),
            hrsPlayingGames = first(hrsPlayingGames)) %>%
  ungroup() %>%
  arrange(id, aoi) %>%
  mutate(faceRatioG = totalG / (totalG+lead(totalG)),
         faceRatioF = totalF / (totalF+lead(totalF))) %>%
  filter(aoi == "FACE") %>%
  select(-aoi, -totalG, -totalF)

# Respondents who did not report watching or playing games count as 0 hours
rq4a.data[is.na(rq4a.data$hrsPlayingGames),]$hrsPlayingGames <- 0
rq4a.data[is.na(rq4a.data$hrsWatchingVGContent),]$hrsWatchingVGContent <- 0

# Remove outliers (those who report more than 12 hours a day)
rq4a.data %>% filter(hrsPlayingGames < 12*7 & hrsWatchingVGContent < 12*7) -> rq4a.data

rq4a.data %>%
  ggplot(aes(x = cut(hrsPlayingGames, breaks = 3), y = faceRatioG)) + 
    geom_boxplot()

rq4a.data %>%
  ggplot(aes(x = cut(hrsWatchingVGContent, breaks = 3), y = faceRatioG)) + 
    geom_boxplot()

rq4a.data %>%
  ggplot(aes(x = hrsPlayingGames, y = faceRatioG)) +
    geom_point() +
    stat_smooth(method = "lm")

rq4a.data %>%
  ggplot(aes(x = hrsWatchingVGContent, y = faceRatioG)) +
    geom_point() +
    stat_smooth(method = "lm")

rq4a.model.1 <- lm(faceRatioG ~ hrsPlayingGames, data = rq4a.data)
par(mfrow = c(2, 2))
plot(rq4a.model.1)
summary(rq4a.model.1)

rq4a.model.2 <- lm(faceRatioG ~ hrsWatchingVGContent, data = rq4a.data)
par(mfrow = c(2, 2))
plot(rq4a.model.2)
summary(rq4a.model.2)

rq4a.data %>% mutate(player = hrsPlayingGames > 0,
                    watcher = hrsWatchingVGContent > 0) -> rq4a.data

shapiro.test(rq4a.data$faceRatioG)
rq4a.data %>% ggplot(aes(x = faceRatioG)) +
  geom_histogram(binwidth = 0.025, aes(y = ..density.., fill = ..count..)) +
  scale_fill_gradient("Count", low="#DCDCDC", high="#7C7C7C") +
  stat_function(fun=dnorm,
                color="red",
                args=list(mean=mean(rq4a.data$faceRatioG), 
                          sd=sd(rq4a.data$faceRatioG)))
# Note that gaze ratio is not (quite) normally distributed

bartlett.test(faceRatioG ~ player, rq4a.data)
bartlett.test(faceRatioG ~ watcher, rq4a.data)
# And variances are not equal

wilcox.test(faceRatioG ~ player, rq4a.data, alternative = "two.sided", correct = F)
wilcox.test(faceRatioG ~ watcher, rq4a.data, alternative = "two.sided", correct = F)
```

There is not a clear trend in terms of experienced players or watchers allocating their attention differentially to the facecam. Note, however, that this analysis implicitly excludes those participants in the non-facecam condition. We might also consider whether these factors affect overall attention allocation (i.e., whether people pay attention to the stimulus at all).

```{r rq4b}
rq4b.data <- vgv %>%
  mutate(hrsWatchingVGContent = hrsWatchingRecordedVGContent_weekday * 5 + 
                                hrsWatchingRecordedVGContent_weekend * 2 +
                                hrsWatchingStreamedVGContent_weekday * 5 +
                                hrsWatchingStreamedVGContent_weekend * 2,
         hrsPlayingGames = hrsPlayingSinglePlayer_weekday * 5 +
                           hrsPlayingSinglePlayer_weekend * 2 +
                           hrsPlayingMultiPlayer_weekday * 5 +
                           hrsPlayingMultiPlayer_weekend * 2) %>%
  group_by(id) %>%
  summarise(totalG = sum(timeSpentG),
            totalF = sum(timeSpentF),
            hrsWatchingVGContent = first(hrsWatchingVGContent),
            hrsPlayingGames = first(hrsPlayingGames))

rq4b.data[is.na(rq4b.data$hrsPlayingGames),]$hrsPlayingGames <- 0
rq4b.data[is.na(rq4b.data$hrsWatchingVGContent),]$hrsWatchingVGContent <- 0

rq4b.data %>% ggplot(aes(x = totalG)) +
  geom_histogram(binwidth = 100000, aes(y = ..density.., fill = ..count..)) +
  scale_fill_gradient("Count", low="#DCDCDC", high="#7C7C7C") +
  stat_function(fun=dnorm,
                color="red",
                args=list(mean=mean(rq4b.data$totalG), 
                          sd=sd(rq4b.data$totalG)))

rq4b.data <- rq4b.data %>% 
  mutate(logG = log(totalG),
         logF = log(totalF))

# Remove outliers (those who report more than 12 hours a day)
rq4b.data %>% filter(hrsPlayingGames < 12*7 & hrsWatchingVGContent < 12*7) -> rq4b.data

rq4b.data %>% ggplot(aes(x = logG)) +
  geom_histogram(binwidth = 0.25, aes(y = ..density.., fill = ..count..)) +
  scale_fill_gradient("Count", low="#DCDCDC", high="#7C7C7C") +
  stat_function(fun=dnorm,
                color="red",
                args=list(mean=mean(rq4b.data$logG), 
                          sd=sd(rq4b.data$logG)))

rq4b.data %>% ggplot(aes(x = logF)) +
  geom_histogram(binwidth = 0.25, aes(y = ..density.., fill = ..count..)) +
  scale_fill_gradient("Count", low="#DCDCDC", high="#7C7C7C") +
  stat_function(fun=dnorm,
                color="red",
                args=list(mean=mean(rq4b.data$logF), 
                          sd=sd(rq4b.data$logF)))

# Remove visual outlier [id = 3694]
rq4b.data <- rq4b.data %>% filter(id != 3694)


rq4b.data %>%
  ggplot(aes(x = hrsPlayingGames, y = logG)) +
    geom_point() +
    stat_smooth(method = "lm")

rq4b.data %>%
  ggplot(aes(x = hrsWatchingVGContent, y = logG)) +
    geom_point() +
    stat_smooth(method = "lm")

rq4b.model <- lm(logG ~ hrsPlayingGames, data = rq4b.data)
par(mfrow = c(2, 2))
plot(rq4b.model)
summary(rq4b.model)

rq4b.data %>% mutate(player = hrsPlayingGames > 0,
                    watcher = hrsWatchingVGContent > 0) -> rq4b.data

bartlett.test(logG ~ player, rq4b.data)
bartlett.test(logG ~ watcher, rq4b.data)

wilcox.test(logG ~ player, rq4b.data, alternative = "two.sided", correct = F)
wilcox.test(logG ~ watcher, rq4b.data, alternative = "two.sided", correct = F)
```

From the above, it also doesn't seem that experienced players of video games or watchers of streamed video game content allocate their overall attention significantly differently. (*Note*: Some steps taken above for cleaning and transforming the attention data should be cross-applied elsewhere within the analysis.)